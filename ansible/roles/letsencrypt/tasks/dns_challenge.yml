# roles/letsencrypt/tasks/dns_challenge.yml
---
- name: Set up acme-dns service and client
  include_tasks: acme-dns.yml

- name: Obtain certificate using acme-dns client for each domain
  ansible.builtin.command: >-
    {{ acme_client_install_path }} -s {{ acme_dns_api_url }} -d {{ item.domain }} -a {{ acme_dns_auth_info_path }} cert
  args:
    creates: "/etc/letsencrypt/live/{{ item.domain }}/fullchain.pem"
  loop: "{{ letsencrypt_certs }}"
  become: yes
  register: cert_result
  changed_when: "'Certificate obtained' in cert_result.stdout"
